<html lang="en">
    <head>
	<meta charset="utf-8">
	<title> Project 1 </title>

	<script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>

	
	<style>
	.bar:hover {
	fill: orange;
}
	path:hover {
	fill-opacity: .7;
}
	button  {float:right}
    body {
            font: 10px sans-serif;
        }
        select {
            display: block;
        }
        .bar {
            fill: purple;
            opacity: 0.8;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
	</style>
    </head>
    <body>
		<section class="section text-center light-bg">
					<h1 class="h1 alt-font medium-weight em">
						Homicides in USA</h1>
		<a href=documentation.html>Documentation</a>
		</section>

		<div id='vis-container'></div>
		

	<script type="text/javascript">
		d3.select("body").append("button")
			.text("Map")
			.on("click",draw_map)
			
		d3.select("body").append("button")
			.text("Bar Chart")
			.on("click",drawPlot)
		
		var months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
		var months_M = ["January_M","February_M","March_M","April_M","May_M","June_M","July_M","August_M","September_M","October_M","November_M","December_M"];
		var months_F = ["January_F","February_F","March_F","April_F","May_F","June_F","July_F","August_F","September_F","October_F","November_F","December_F"];
		 
		
		////////////////////////
		
		
		function draw_map()
		{
			 d3.select("#vis-container").selectAll('*').remove()
			 
			 var margin = { top: 30, right: 50, bottom: 60, left: 30 },
                 width  = 850 - margin.left - margin.right,
                 height = 550 - margin.top  - margin.bottom;
                 
             // D3 Projection
			 var projection = d3.geo.albersUsa()
				   .translate([width/2, height/2])    // translate to center of screen
				   .scale([1000]);          // scale things down so see entire US    
				   
			 // Define path generator
			 var path = d3.geo.path()              // path generator that will convert GeoJSON to SVG paths
		  	 		  .projection(projection);  // tell path generator to use albersUsa projection
		  	 		  
		  	 // Define linear scale for output
			 var color = d3.scale.linear()
			  		  .range(["rgb(213,222,217)","rgb(69,173,168)","rgb(84,36,55)","rgb(217,91,67)"]);
			  		  
			 var legendText = ["531 or more", "221-530", "71-220","70 or less"];
			 
			 var svg = d3.select("#vis-container")
			 	.append("svg")
			 	.attr("width", width)
				.attr("height", height)
				
				
			 // Load in my states data!
			d3.csv("./data/deaths_by_state.csv", function(data) {
			color.domain([1,2,3,4]); // setting the range of the input data

			// Load GeoJSON data and merge with states data
				d3.json("./data/us-states.json", function(json) {
					for (var i = 0; i < data.length; i++) {

						// Grab State Name
						var dataState = data[i].state;

						// Grab data value 
						var dataValue = data[i].death_range;
						var dataValue_deaths = data[i].Deaths;

						// Find the corresponding state inside the GeoJSON
						for (var j = 0; j < json.features.length; j++)  {
							var jsonState = json.features[j].properties.name;

								if (dataState == jsonState) {

								// Copy the data value into the JSON
								json.features[j].properties.death_range = dataValue; 
								json.features[j].properties.Deaths = dataValue_deaths
								json.features[j].properties.state = dataState

								// Stop looking through the JSON
								break;	
								}
						}
					}
								
					// Bind the data to the SVG and create one path per GeoJSON feature
					svg.selectAll("path")
						.data(json.features)
						.enter()
						.append("path")
						.attr("d", path)
						//.on('mouseover',function(d){console.log(d.properties.state)})
						.style("stroke", "#fff")
						.style("stroke-width", "1")
						.style("fill", function(d) {
						
						// Get data value
						var value = d.properties.death_range;

						if (value) {
						//If value exists…
						return color(value);
						} else {
						//If value is undefined…
						return "rgb(213,222,217)";
						}
						})
						.append("title") // Tooltip
      					   .text(function(d) { return d.properties.state+ " : " +d.properties.Deaths ; })
						
						
					var legend = d3.select("#vis-container").append("svg")
      							.attr("class", "legend")
     							.attr("width", 140)
    							.attr("height", 200)
   								.selectAll("g")
   								.data(color.domain().slice().reverse())
   								.enter()
   								.append("g")
     							.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  						legend.append("rect")
   		  					.attr("width", 18)
   		  					.attr("height", 18)
   		  					.style("fill", color);

  						legend.append("text")
  		  					.data(legendText)
      	  					.attr("x", 24)
      	  					.attr("y", 9)
      	  					.attr("dy", ".35em")
      	  					.text(function(d) { return d; });
      	  	
				});
			});
		}
				
		////////////////
				
		function drawPlot()
		{
				
		d3.select("#vis-container").selectAll('*').remove() 
			 
			 d3.csv("./data/cir_by_month_MF.csv",function(data){
			var cir_death = {};
			data.forEach(function(d) {
				var cir = d.Circumstance;
				cir_death[cir] = [];
				
					
				// { month: [ bar1Val, bar2Val, ... ] }	
				months.forEach(function(month) {
					cir_death[cir].push( +d[month] ); // without the "+", each would be recorded as a string
				});
				
					
			
			});
			
			
			draw_pairplot(cir_death);
			
			
			});		
				
		}
		///////////////////		
				
		
		
		function draw_pairplot(cir_death) 
		{
		
			 		 
			 var margin = { top: 30, right: 50, bottom: 60, left: 50 },
                 width  = 500 - margin.left - margin.right,
                 height = 350 - margin.top  - margin.bottom;
                 
             // Make x scale
             var xScale = d3.scale.ordinal()
             	 .domain(months)
             	 .rangeRoundBands([0,width],0.1);
             	 
             // Make y scale, the domain will be defined on bar update
             var yScale = d3.scale.linear()
             	 .range([height,0]);
             	 
             // Create canvas
             var canvas = d3.select("#vis-container")
             	.append("svg")
             	 .attr("width", width  + margin.left + margin.right)
             	 .attr("height", height + margin.top  + margin.bottom)
             	.append("g")
             	 .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
             	
             // Make x-axis and add to canvas
             var xAxis = d3.svg.axis()
             	 .scale(xScale)
             	 .orient("bottom");
             	 
             canvas.append("g")
             	 .attr("class","x axis")
             	 .attr("transform", "translate(0," + height + ")")
             	 .call(xAxis)
             	 .selectAll("text")
             	 .style("text-anchor", "end")
             	 .attr("dx", "-1.1em")
      			 .attr("dy", "-.55em")
             	 .attr("transform", "rotate(-90)" );
             	 
             // Make y-axis and add to canvas
             var yAxis = d3.svg.axis()
             	 .scale(yScale)
             	 .orient("left");
             	 
             var yAxisHandleForUpdate = canvas.append("g")
             	 .attr("class","y axis")
             	 .call(yAxis);
             	 
             yAxisHandleForUpdate.append("text")
             	 .attr("transform", "rotate(-90)")
             	 .attr("y", 6)	
                 .attr("dy", ".71em")
                 .style("text-anchor", "end")
                 .text("Deaths");
                 
             var updateBars = function(data,cir) {
                      
                
             	 // First update the y-axis domain to match data
             	 yScale.domain( d3.extent(data) );
				 yAxisHandleForUpdate.call(yAxis);
				
				 var bars = canvas.selectAll(".bar").data(data);
				   
				 // Add bars for new data
				 bars.enter()
				   .append("rect")
				   	 
				     .attr("class","bar")
				     .attr("x",function(d,i) {return xScale( months[i] ); })
				     .attr("width",xScale.rangeBand())
				     .attr("y",function(d,i) {return yScale(d); })
				     .attr("height",function(d,i) {return height - yScale(d); })
				     
		         	 
				      
				 // Update  old ones, already have x / width from before
				 bars
				 	 .transition().duration(250)
				 	 .attr("y",function(d,i) {return yScale(d); })
				 	 .attr("height", function(d,i) { return height - yScale(d); });
				 	 
				 // Remove old ones
                 bars.exit().remove();
                 
                 bars.on("mouseover", function(d,i){getPieData(cir,i)})
                 	 //.on("mouseout", removePie)
                 	 
                 
                 ////
                 
                 
                 
                 ////
                 
                 };
                 
                 
                 // Handler for dropdown value change
				 var dropdownChange = function() {
                    var newCir = d3.select(this).property('value'),
                        newData   = cir_death[newCir];
						
                    updateBars(newData,newCir);
                };
				
				// Get names of months, for dropdown
                var all_cir = Object.keys(cir_death).sort();
                
                var dropdown = d3.select("#vis-container")
                    .insert("select", "svg")
                    .on("change", dropdownChange);
                    
                dropdown.selectAll("option")
                    .data(all_cir)
                  .enter().append("option")
                    .attr("value", function (d) { return d; })
                    .text(function (d) {
                        return d[0].toUpperCase() + d.slice(1,d.length); // capitalize 1st letter
                    });
                    
                var initialData = cir_death[ all_cir[0] ];
                updateBars(initialData,all_cir[0]);
				
		
		};
		
		
	   	var getPieData = function(cir2,i) 
		{
			d3.csv("./data/cir_by_month_MF.csv",function(data){
			var cir_death_M = {};
			var cir_death_F = {};
			data.forEach(function(d) {
				var cir = d.Circumstance;
				cir_death_M[cir] = [];
				cir_death_F[cir] = [];
				
					
				// { month: [ bar1Val, bar2Val, ... ] }	
				months_M.forEach(function(month) {
					cir_death_M[cir].push( +d[month] ); // without the "+", each would be recorded as a string
				});
				months_F.forEach(function(month) {
					cir_death_F[cir].push( +d[month] ); // without the "+", each would be recorded as a string
				});
					
			
			});
			m_value = cir_death_M[cir2][i]
			f_value = cir_death_F[cir2][i]
			
			pie_data = [{"label":"male", "value":m_value}, 
            {"label":"Female", "value":f_value}];
			
			
			
			drawPie(pie_data)
		
		});
		}
			
  		/*var removePie = function()
  		{
  			d3.select("#gender_piechart").remove();
  		}*/
  		
  		
  		
		var drawPie = function(data) 
		{
			d3.select("#gender_piechart").remove();
			
			var w = 300,                        //width
    h = 300,                            //height
    r = 60,                            //radius
    color = d3.scale.category20c();     //builtin range of colors

    data = data;
    
    var vis = d3.select("#vis-container")
        .append("svg:svg")              //create the SVG element inside the <body>
        .attr("id","gender_piechart")
        .data([data])                   //associate our data with the document
            .attr("width", w)           //set the width and height of our visualization (these will be attributes of the <svg> tag
            .attr("height", h)
        .append("svg:g")                //make a group to hold our pie chart
            .attr("transform", "translate(" + r + "," + r + ")")    //move the center of the pie chart from 0, 0 to radius, radius

    var arc = d3.svg.arc()              //this will create <path> elements for us using arc data
        .outerRadius(r);

    var pie = d3.layout.pie()           //this will create arc data for us given a list of values
        .value(function(d) { return d.value; });    //we must tell it out to access the value of each element in our data array

    var arcs = vis.selectAll("g.slice")     //this selects all <g> elements with class slice (there aren't any yet)
        .data(pie)                          //associate the generated pie data (an array of arcs, each having startAngle, endAngle and value properties) 
        .enter()                            //this will create <g> elements for every "extra" data element that should be associated with a selection. The result is creating a <g> for every object in the data array
            .append("svg:g")                //create a group to hold each slice (we will have a <path> and a <text> element associated with each slice)
                .attr("class", "slice");    //allow us to style things in the slices (like text)

        arcs.append("svg:path")
                .attr("fill", function(d, i) { return color(i); } ) //set the color for each slice to be chosen from the color function defined above
                .attr("d", arc);                                    //this creates the actual SVG path using the associated data (pie) with the arc drawing function

        arcs.append("svg:text")                                     //add a label to each slice
                .attr("transform", function(d) {                    //set the label's origin to the center of the arc
                //we have to make sure to set these before calling arc.centroid
                d.innerRadius = 0;
                d.outerRadius = r;
                return "translate(" + arc.centroid(d) + ")";        //this gives us a pair of coordinates like [50, 50]
            })
            .attr("text-anchor", "middle")                          //center the text on it's origin
            .text(function(d, i) { return data[i].label; });        //get the label from our original data array
		
			
		}
			
		
	</script>
    </body>
</html>

		
